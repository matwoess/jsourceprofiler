
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="jsourceprofiler is a command-line profiler for Java programs using source code instrumentation.
The single JAR-file utility generates HTML reports enabling hotspot analysis and providing coverage with line counts. 
It features an optional JavaFX tool-runner GUI.
">
      
      
      
      
        <link rel="prev" href="../report/">
      
      
        <link rel="next" href="../runtime-impact/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.3">
    
    
      
        <title>Implementation Details - jsourceprofiler Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.d7758b05.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#implementation-details" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="jsourceprofiler Docs" class="md-header__button md-logo" aria-label="jsourceprofiler Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            jsourceprofiler Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Implementation Details
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 2C5.13 2 2 5.13 2 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.87-3.13-7-7-7M6 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H6zm13-8h-2l-3.2 9h1.9l.7-2h3.2l.7 2h1.9zm-2.15 5.65L18 15l1.15 3.65z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="light-blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 6a6 6 0 0 1 6 6c0 2.22-1.21 4.16-3 5.2V19a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1v-1.8c-1.79-1.04-3-2.98-3-5.2a6 6 0 0 1 6-6m2 15v1a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-1zm6-10h3v2h-3zM1 11h3v2H1zM13 1v3h-2V1zM4.92 3.5l2.13 2.14-1.42 1.41L3.5 4.93zm12.03 2.13 2.12-2.13 1.43 1.43-2.13 2.12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="yellow"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/matwoess/jsourceprofiler" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    matwoess/jsourceprofiler
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="jsourceprofiler Docs" class="md-nav__button md-logo" aria-label="jsourceprofiler Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    jsourceprofiler Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/matwoess/jsourceprofiler" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    matwoess/jsourceprofiler
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Usage
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../workflow/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tool Workflow
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../fxui/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    JavaFX UI
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../report/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Report
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Implementation Details
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Implementation Details
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#grammarparser" class="md-nav__link">
    <span class="md-ellipsis">
      Grammar/Parser
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instrumentation" class="md-nav__link">
    <span class="md-ellipsis">
      Instrumentation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-__counter-class" class="md-nav__link">
    <span class="md-ellipsis">
      The __Counter class
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#special-handling-of-language-features" class="md-nav__link">
    <span class="md-ellipsis">
      Special handling of language features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Special handling of language features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-statements" class="md-nav__link">
    <span class="md-ellipsis">
      Single-statements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overloaded-constructors" class="md-nav__link">
    <span class="md-ellipsis">
      Overloaded constructors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#anonymous-and-local-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Anonymous and local classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#brace-less-lambdas" class="md-nav__link">
    <span class="md-ellipsis">
      Brace-less Lambdas
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#switch-statements-and-switch-expressions" class="md-nav__link">
    <span class="md-ellipsis">
      Switch statements and switch expressions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#control-flow-breaks" class="md-nav__link">
    <span class="md-ellipsis">
      Control flow breaks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../runtime-impact/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Runtime Impact
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../limitations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Limitations
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../dependencies/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dependencies
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Additional Resources
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            Additional Resources
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../docs/api/index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Javadoc
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../darkdocs/api/index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Javadoc (dark theme)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#grammarparser" class="md-nav__link">
    <span class="md-ellipsis">
      Grammar/Parser
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instrumentation" class="md-nav__link">
    <span class="md-ellipsis">
      Instrumentation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-__counter-class" class="md-nav__link">
    <span class="md-ellipsis">
      The __Counter class
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#special-handling-of-language-features" class="md-nav__link">
    <span class="md-ellipsis">
      Special handling of language features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Special handling of language features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-statements" class="md-nav__link">
    <span class="md-ellipsis">
      Single-statements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overloaded-constructors" class="md-nav__link">
    <span class="md-ellipsis">
      Overloaded constructors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#anonymous-and-local-classes" class="md-nav__link">
    <span class="md-ellipsis">
      Anonymous and local classes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#brace-less-lambdas" class="md-nav__link">
    <span class="md-ellipsis">
      Brace-less Lambdas
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#switch-statements-and-switch-expressions" class="md-nav__link">
    <span class="md-ellipsis">
      Switch statements and switch expressions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#control-flow-breaks" class="md-nav__link">
    <span class="md-ellipsis">
      Control flow breaks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="implementation-details">Implementation details</h1>
<p>This section gives some more information on how the profiler works in detail.</p>
<h2 id="grammarparser">Grammar/Parser</h2>
<p>The Grammar consists of a reduced set of non-terminal symbols (NTS) that covers the most important aspects
of the Java 21 syntax, tailored for the profiler's use-case: finding the start and end position of blocks.</p>
<p>Using Coco's <code>ANY</code> keyword, we over-read non-relevant tokens like:</p>
<ul>
<li>access modifiers (<code>public</code>, <code>private</code>, ... )</li>
<li>interfaces that a class <code>implements</code> (or superclasses)</li>
<li>class level constants and member variables</li>
<li>generic type definitions with angle brackets <code>&lt;Type1&lt;Type2,...&gt;, ...&gt;</code></li>
<li>array initializer blocks (starting with <code>{</code>), but we do not insert counters here</li>
<li>a method’s argument list (within the parentheses)</li>
<li>remaining tokens in a <code>GenericStatement</code> up to the semicolon</li>
<li>a switch's case label(s), constant(s) and guard clause(s) before the colon or arrow</li>
</ul>
<p>To build an index of classes and their methods, we have to keep track of class and method names 
in each file and assign them to the block objects in the model.
Package declarations at the beginning of a file have to be propagated to each class to determine fully qualified names.</p>
<p>Therefore, we used the semantic action syntax of Coco/R to insert our custom statements into the final generated parser file.
Arbitrary Java statements can be included in the ATG in the form of <code>(. STATEMENT; .)</code> blocks.
We use this to add hooks for our <code>ParserState</code> helper class.</p>
<p>E.g. to parse the full package name an NTS like this could be defined:</p>
<div class="language-text highlight"><span class="filename">JavaFile.atg</span><pre><span></span><code><span id="__span-0-1">PackageDecl = &quot;package&quot;     (. ArrayList&lt;String&gt; packageName = new ArrayList&lt;&gt;(); .)
</span><span id="__span-0-2">    ident                   (. packageName.add(t.val); .)
</span><span id="__span-0-3">    {&#39;.&#39; ident              (. packageName.add(t.val); .)
</span><span id="__span-0-4">    }
</span><span id="__span-0-5">    &quot;;&quot;                     (. state.setPackageName(packageName); .)
</span><span id="__span-0-6">.
</span></code></pre></div>
<p>Which would result in the following generated parser (pseudo-code) method: </p>
<div class="language-java highlight"><span class="filename">Parser.java</span><pre><span></span><code><span id="__span-1-1"><span class="kt">void</span><span class="w"> </span><span class="nf">PackageDecl</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-2"><span class="w">    </span><span class="n">Expect</span><span class="p">(</span><span class="s">&quot;package&quot;</span><span class="p">);</span>
</span><span id="__span-1-3"><span class="hll"><span class="w">    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">packageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span>
</span></span><span id="__span-1-4"><span class="w">    </span><span class="n">Expect</span><span class="p">(</span><span class="n">IDENT</span><span class="p">);</span>
</span><span id="__span-1-5"><span class="hll"><span class="w">    </span><span class="n">packageName</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="na">val</span><span class="p">);</span><span class="w"> </span>
</span></span><span id="__span-1-6"><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">la</span><span class="p">.</span><span class="na">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DOT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-7"><span class="w">        </span><span class="n">Get</span><span class="p">();</span>
</span><span id="__span-1-8"><span class="w">        </span><span class="n">Expect</span><span class="p">(</span><span class="n">IDENT</span><span class="p">);</span>
</span><span id="__span-1-9"><span class="hll"><span class="w">        </span><span class="n">packageName</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="na">val</span><span class="p">);</span><span class="w"> </span>
</span></span><span id="__span-1-10"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-11"><span class="w">    </span><span class="n">Expect</span><span class="p">(</span><span class="s">&quot;;&quot;</span><span class="p">);</span>
</span><span id="__span-1-12"><span class="hll"><span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="na">setPackageName</span><span class="p">(</span><span class="n">packageName</span><span class="p">);</span><span class="w"> </span>
</span></span><span id="__span-1-13"><span class="p">}</span>
</span></code></pre></div>
<p>(where <code>t</code> is the current token, <code>la</code> the look-ahead token and <code>state</code> the <code>ParserState</code> instance)</p>
<p>In this way our state class is automatically updated during the recursive-descent parsing of Java source files,
and we can build our metadata whenever we encounter a new relevant token.</p>
<h2 id="instrumentation">Instrumentation</h2>
<p>The tool parses source code files and stores an instrumented copy in the output directory.
At the beginning of executable code blocks (usually after an opening brace <code>{</code>). a <code>__Counter.inc(X);</code> statement is
inserted.</p>
<p>A program like:
<div class="language-java highlight"><pre><span></span><code><span id="__span-2-1"><span class="kd">class</span> <span class="nc">Fibonacci</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">fib</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-3"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-4"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</span><span id="__span-2-5"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-6"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</span><span id="__span-2-7"><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-8"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-9"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">);</span>
</span><span id="__span-2-10"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-11"><span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="n">fib</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">);</span>
</span><span id="__span-2-12"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-13"><span class="w">  </span><span class="p">}</span>
</span><span id="__span-2-14"><span class="p">}</span>
</span></code></pre></div></p>
<p>Would look in its instrumented version something like this:
<div class="language-java highlight"><pre><span></span><code><span id="__span-3-1"><span class="hll"><span class="s">&quot;import auxiliary.__Counter;&quot;</span>
</span></span><span id="__span-3-2"><span class="kd">class</span> <span class="nc">Fibonacci</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-3"><span class="hll"><span class="w">  </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">fib</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;__Counter.inc(0);&quot;</span>
</span></span><span id="__span-3-4"><span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;__Counter.inc(1);&quot;</span>
</span></span><span id="__span-3-5"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</span><span id="__span-3-6"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-7"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</span><span id="__span-3-8"><span class="w">  </span><span class="p">}</span>
</span><span id="__span-3-9"><span class="hll"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;__Counter.inc(2);&quot;</span>
</span></span><span id="__span-3-10"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">);</span>
</span><span id="__span-3-11"><span class="hll"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;__Counter.inc(3);&quot;</span>
</span></span><span id="__span-3-12"><span class="w">      </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="n">fib</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">);</span>
</span><span id="__span-3-13"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-14"><span class="w">  </span><span class="p">}</span>
</span><span id="__span-3-15"><span class="p">}</span>
</span></code></pre></div></p>
<p>Counter statements are always appended to the end of a line, to preserve the original line numbers.
This is especially important for getting correct lines numbers when an exception is thrown during execution 
of the instrumented program.</p>
<h2 id="the-__counter-class">The <code>__Counter</code> class</h2>
<p>To successfully compile a copy of the program with additional <code>__Counter.inc(x)</code> statements,
we need to import the <code>__Counter</code> class inside each instrumented file.
The class is contained in a root-level <code>auxiliary</code> package so that can be imported at any level in the hierarchy.</p>
<p>A compiled <code>.class</code> version of <code>__Counter</code> is extracted from the tool's JAR and copied
to the <code>instrumented/</code> and <code>classes/</code> output directories.</p>
<p>The counter class stores an array the size of all (number of) all found blocks in the entire project.
Every <code>__Counter.inc(idx)</code> statement includes the block index <code>idx</code> to increment.</p>
<p>By default, calls to <code>inc</code> are not synchronized to speed up runtime performance.
Using the <code>-s</code> / <code>--synchronized</code> option we insert <code>incSync</code> statements instead.
The counters are then kept in an <code>AtomicLongArray</code> to ensure exact results for multi-threaded programs.</p>
<h2 id="special-handling-of-language-features">Special handling of language features</h2>
<p>Some language syntax constructs required special non-trivial handling during instrumentation.</p>
<h3 id="single-statements">Single-statements</h3>
<p>We cannot just add a counter-statement to brace-less single-statement blocks.
<br/>
They have to be wrapped in braces for it to compile successfully.</p>
<p>The following example:</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-4-1"><span class="kt">boolean</span><span class="w"> </span><span class="nf">containsZero</span><span class="p">(</span><span class="kt">int</span><span class="o">[][]</span><span class="w"> </span><span class="n">array</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-2"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">array</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-4-3"><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">array</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-4-4"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">array</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-4-5"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">array</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-4-6"><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-4-7"><span class="p">}</span>
</span></code></pre></div>
<p>would require insertions of:</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-5-1"><span class="hll"><span class="kt">boolean</span><span class="w"> </span><span class="nf">containsZero</span><span class="p">(</span><span class="kt">int</span><span class="o">[][]</span><span class="w"> </span><span class="n">array</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;__Counter.inc(261);&quot;</span>
</span></span><span id="__span-5-2"><span class="hll"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">array</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="s">&quot;{__Counter.inc(262);&quot;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="s">&quot;}&quot;</span>
</span></span><span id="__span-5-3"><span class="hll"><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">array</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="s">&quot;{__Counter.inc(263);&quot;</span>
</span></span><span id="__span-5-4"><span class="hll"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">array</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="s">&quot;{__Counter.inc(264);&quot;</span>
</span></span><span id="__span-5-5"><span class="hll"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">array</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="s">&quot;{__Counter.inc(265);&quot;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="s">&quot;}}}&quot;</span>
</span></span><span id="__span-5-6"><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
</span><span id="__span-5-7"><span class="p">}</span>
</span></code></pre></div>
<h3 id="overloaded-constructors">Overloaded constructors</h3>
<p>Java supports multiple “overloaded” constructors in the same class. If we use <code>super()</code>
or <code>this()</code> invocations, the language (currently) enforces that it must be the first statement in the
method body.
This makes it impossible to insert a <code>__Counter.inc(X);</code> statement right after the method's opening brace.</p>
<p>To handle this special case, we need to keep track of the <strong>end</strong> position of possible first <code>this/super</code> calls
in constructors.
The counter-statement is added only <strong>after</strong> this call.</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-6-1"><span class="kd">class</span> <span class="nc">SmallDog</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Dog</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-2"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">SmallDog</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-3"><span class="hll"><span class="w">    </span><span class="kd">super</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="p">);</span><span class="s">&quot;__Counter.inc(3);&quot;</span>
</span></span><span id="__span-6-4"><span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Size</span><span class="p">.</span><span class="na">SMALL</span><span class="p">;</span>
</span><span id="__span-6-5"><span class="w">    </span><span class="kd">super</span><span class="p">.</span><span class="na">speak</span><span class="p">();</span>
</span><span id="__span-6-6"><span class="w">  </span><span class="p">}</span>
</span><span id="__span-6-7"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">SmallDog</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="n">Size</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-8"><span class="hll"><span class="w">    </span><span class="k">this</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="p">);</span><span class="s">&quot;__Counter.inc(4);&quot;</span>
</span></span><span id="__span-6-9"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
</span><span id="__span-6-10"><span class="w">  </span><span class="p">}</span>
</span><span id="__span-6-11"><span class="w">  </span><span class="p">...</span>
</span><span id="__span-6-12"><span class="p">}</span>
</span></code></pre></div>
<h3 id="anonymous-and-local-classes">Anonymous and local classes</h3>
<p>As these full-fledged classes can appear anywhere inside a code block,
we need need to restore the previous state after entering, parsing, and exiting these inner classes.
For this, the <code>ParserState</code> class contains a Stack for methods, onto which we push
the current one when encountering class declarations inside methods. As soon as we exit the class,
we pop the method from the stack and continue parsing the outer method.</p>
<h3 id="brace-less-lambdas">Brace-less Lambdas</h3>
<p>Lambda statements are often used without a method body, especially for stream processing.</p>
<p>Given the example:</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-7-1"><span class="n">integers</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
</span><span id="__span-7-2"><span class="w">        </span><span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span><span id="__span-7-3"><span class="w">        </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-7-4"><span class="w">        </span><span class="p">.</span><span class="na">sum</span><span class="p">();</span>
</span></code></pre></div>
<p>We need a clever way to observe how often each lambda statement was executed.</p>
<p>The <code>__Counter</code> class contains a special <code>incLambda</code> method that wraps these lambdas
as an argument into either a generic anonymous <code>Runnable</code> or <code>Supplier&lt;T&gt;</code>.</p>
<p>The instrumented version would look like this:</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-8-1"><span class="n">integers</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span>
</span><span id="__span-8-2"><span class="hll"><span class="w">        </span><span class="p">.</span><span class="na">peek</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="s">&quot;__Counter.incLambda(61, () -&gt;&quot;</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="s">&quot;)&quot;</span><span class="p">)</span>
</span></span><span id="__span-8-3"><span class="hll"><span class="w">        </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="s">&quot;__Counter.incLambda(62, () -&gt;&quot;</span><span class="w">  </span><span class="n">x</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="s">&quot;)&quot;</span><span class="p">)</span>
</span></span><span id="__span-8-4"><span class="w">        </span><span class="p">.</span><span class="na">sum</span><span class="p">();</span>
</span></code></pre></div>
<p>The compiler will automatically choose the fitting <code>incLambda</code> variant to call, depending on the return type.</p>
<h3 id="switch-statements-and-switch-expressions">Switch statements and switch expressions</h3>
<p>Switch statements need a lot of special handling due to their abnormal syntax.
<br/>
The switch block itself is not executable, <code>case</code> blocks are not enclosed in braces.
<br/>
Switch <strong>expression</strong> (introduced in Java 14) have the <code>yield</code> statement to return a value.
<br/>
We also can use arrow-cases (same <code>-&gt;</code> operator as for lambdas) to omit the <code>break</code>, in which case
there's either a curly-brace block or a single statement.</p>
<p>For the case of <em>single-statement</em> arrow-case expressions we need to wrap
the block in braces and add a <code>yield</code> keyword after the counter statement.
<br/>
In case a branch throws an exception, <code>yield</code> <strong>must not</strong> be added.</p>
<p>The following example:</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-9-1"><span class="n">StatusCode</span><span class="w"> </span><span class="n">statusCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span>
</span><span id="__span-9-2"><span class="kt">int</span><span class="w"> </span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">statusCode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-3"><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span>
</span><span id="__span-9-4"><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">UNAUTHORIZED</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">401</span><span class="p">;</span>
</span><span id="__span-9-5"><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">FORBIDDEN</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">403</span><span class="p">;</span>
</span><span id="__span-9-6"><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">NOTFOUND</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">yield</span><span class="w"> </span><span class="mi">404</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-9-7"><span class="w">  </span><span class="k">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;invalid code&quot;</span><span class="p">);</span>
</span><span id="__span-9-8"><span class="p">};</span>
</span></code></pre></div>
<p>is instrumented as following:</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-10-1"><span class="n">StatusCode</span><span class="w"> </span><span class="n">statusCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span>
</span><span id="__span-10-2"><span class="kt">int</span><span class="w"> </span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">statusCode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-3"><span class="hll"><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="o">-&gt;</span><span class="s">&quot;{__Counter.inc(5); yield&quot;</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span><span class="s">&quot;}&quot;</span>
</span></span><span id="__span-10-4"><span class="hll"><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">UNAUTHORIZED</span><span class="w"> </span><span class="o">-&gt;</span><span class="s">&quot;{__Counter.inc(6); yield&quot;</span><span class="w"> </span><span class="mi">401</span><span class="p">;</span><span class="s">&quot;}&quot;</span>
</span></span><span id="__span-10-5"><span class="hll"><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">FORBIDDEN</span><span class="w"> </span><span class="o">-&gt;</span><span class="s">&quot;{__Counter.inc(7); yield&quot;</span><span class="w"> </span><span class="mi">403</span><span class="p">;</span><span class="s">&quot;}&quot;</span>
</span></span><span id="__span-10-6"><span class="hll"><span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="n">NOTFOUND</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;__Counter.inc(8);&quot;</span><span class="w"> </span><span class="kd">yield</span><span class="w"> </span><span class="mi">404</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
</span></span><span id="__span-10-7"><span class="hll"><span class="w">  </span><span class="k">default</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="s">&quot;{__Counter.inc(9);&quot;</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;invalid code&quot;</span><span class="p">);</span><span class="s">&quot;}&quot;</span>
</span></span><span id="__span-10-8"><span class="p">};</span>
</span></code></pre></div>
<h3 id="control-flow-breaks">Control flow breaks</h3>
<p>The keywords <code>break</code>, <code>continue</code>, <code>return</code>, <code>yield</code> and <code>throw</code> are used to exit a block early.
As our counters are inserted only at the <strong>beginning</strong> of blocks, we would need another counter
after every block (containing a control flow break statement) to correctly show line-hit coverage.</p>
<p>We took a different approach by introducing "code regions" to group together statements with the same hit count.
A code block is split into two regions when encountering an inner block.
If the inner block contains a control flow break, we subtract the hit count of the inner blocks
from the previous region's hit-count to calculate how frequently the following region was executed.</p>
<div class="language-java highlight"><pre><span></span><code><span id="__span-11-1"><span class="mi">275</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">fib</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-2"><span class="mi">275</span><span class="w">     </span><span class="o">|</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-11-3"><span class="mi">275</span><span class="w"> </span><span class="mi">142</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
</span><span id="__span-11-4"><span class="hll"><span class="mi">275</span><span class="w">     </span><span class="o">|</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// 275-142 = 133</span>
</span></span><span id="__span-11-5"><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../report/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Report">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Report
              </div>
            </div>
          </a>
        
        
          
          <a href="../runtime-impact/" class="md-footer__link md-footer__link--next" aria-label="Next: Runtime Impact">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Runtime Impact
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.footer", "content.code.copy", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.sections"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
    
  </body>
</html>